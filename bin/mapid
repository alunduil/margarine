#!/usr/bin/env python2
# -*- coding: UTF-8 -*-
#
# Copyright (C) 2013 by Alex Brandt <alex.brandt@rackspace.com>
#
# pycore is freely distributable under the terms of an MIT-style license.
# See COPYING or http://www.opensource.org/licenses/mit-license.php.

import logging
import logging.config
import os
import argparse

from margarine.parameters import Parameters
from margarine.parameters import CONFIGURATION_DIRECTORY

logging.basicConfig(level = logging.DEBUG)

Parameters("logging", parameters = [
    { # --logging-configuration=FILE; FILE ‚Üê CONFIGURATION_DIRECTORY/logging.conf
        "options": [ "--configuration" ],
        "default": os.path.join(CONFIGURATION_DIRECTORY, "logging.conf"),
        "help": \
                "The configuration file containing the logging " \
                "mechanism used by %(prog)s.  Default: %(default)s.",
        },
    ])

PARAMETERS = Parameters()
PARAMETERS.parse(only_known = True)

logging.config.fileConfig(PARAMETERS["logging.configuration"])

from margarine.api.application import APPLICATION

logger = logging.getLogger(__name__)

def extract_flask_parameters(parameters):
    flask_parameters = {}

    if "host" in parameters:
        flask_parameters["host"] = parameters["host"]

    if "port" in parameters:
        flask_parameters["port"] = parameters["port"]
    
    if "debug" in parameters:
        flask_parameters["debug"] = parameters["debug"]

    return flask_parameters

if __name__ == "__main__":
    parameters = Parameters()

    parameters.parse(only_known = True)
    
    Parameters(file_path = parameters["configuration"])

    parameters.parse()

    APPLICATION.run(**extract_flask_parameters(parameters))


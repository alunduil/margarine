#!/usr/bin/env python
#
# Copyright (C) 2013 by Alex Brandt <alex.brandt@rackspace.com>
#
# pycore is freely distributable under the terms of an MIT-style license.
# See COPYING or http://www.opensource.org/licenses/mit-license.php.

import logging
import os
import logging.config
import argparse

from margarine.parameters import Parameters
from margarine.parameters import CONFIGURATION_DIRECTORY

from margarine.api.application import APPLICATION
from margarine.api.parameters import PARAMETERS

logger = logging.getLogger(__name__)

def get_parameters():
    parser = argparse.ArgumentParser()
    parser.add_argument("--configuration", "-f",
            default = os.path.join(CONFIGURATION_DIRECTORY, __file__ + ".conf")
            )
    pre_arguments, _ = parser.parse_known_args()

    return Parameters(__name__, pre_arguments.configuration, PARAMETERS)

def configure_logging(parameters):
    if os.access(parameters["logging_configuration"], os.R_OK):
        logging.config.fileConfig(parameters["logging_configuration"])

def extract_flask_parameters(parameters):
    flask_parameters = {}

    if "host" in parameters:
        flask_parameters["host"] = parameters["host"]

    if "port" in parameters:
        flask_parameters["port"] = parameters["port"]
    
    if logging.getLogger().getEffectiveLevel() == logging.DEBUG:
        flask_parameters["debug"] = True 

    return flask_parameters

if __name__ == "__main__":
    parameters = get_parameters()

    configure_logging(parameters)

    APPLICATION.run(**extract_flask_parameters(parameters))

